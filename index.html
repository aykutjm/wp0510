<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Kampanya Yöneticisi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-width: 250px; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        .sidebar { width: var(--sidebar-width); transition: transform 0.3s ease-in-out; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #374151; color: white; }
        #logout-btn:hover { background-color: #c81e1e; }
        .status-badge { padding: 2px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; text-transform: capitalize; }
        .status-taslak { background-color: #6b7280; color: #ffffff; }
        .status-planlandı { background-color: #3b82f6; color: #ffffff; }
        .status-gönderiliyor { background-color: #f59e0b; color: #ffffff; }
        .status-tamamlandı { background-color: #16a34a; color: #ffffff; }
        .status-durduruldu { background-color: #ef4444; color: #ffffff; }
        
        .device-status { padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
        .device-connected { background-color: #dcfce7; color: #166534; border: 1px solid #86efac;}
        .device-disconnected { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;}
        .device-connecting { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047;}

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .modal { display: none; }
        .modal.active { display: flex; }
        
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            width: 100%;
            height: 8px;
        }
        .progress-bar-inner {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-2xl max-w-sm w-full">
            <!-- Login Form (Initially visible) -->
            <div id="login-form">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Giriş Yap</h2>
                <p class="text-gray-600 mb-6 text-center">Hesabınıza erişmek için giriş yapın.</p>
                <input type="email" id="login-email" placeholder="E-posta Adresi" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Şifre" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full">
                    Giriş Yap
                </button>
                <p class="mt-4 text-sm text-center">Hesabınız yok mu? <a href="#" id="show-signup" class="text-blue-600 hover:underline">Hesap Oluştur</a></p>
            </div>

            <!-- Signup Form (Initially hidden) -->
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Hesap Oluştur</h2>
                <p class="text-gray-600 mb-6 text-center">Yeni bir hesap oluşturun.</p>
                <input type="email" id="signup-email" placeholder="E-posta Adresi" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="signup-password" placeholder="Şifre" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                <button id="signup-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full">
                    Kayıt Ol
                </button>
                <p class="mt-4 text-sm text-center">Zaten bir hesabınız var mı? <a href="#" id="show-login" class="text-blue-600 hover:underline">Giriş Yap</a></p>
            </div>
        </div>
    </div>


    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-gray-800 text-gray-300 flex flex-col z-30 hidden">
        <div class="px-6 py-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white flex items-center">
                <i class="fab fa-whatsapp text-green-500 mr-3"></i> Owa<span class="text-green-400">Tech</span>
            </h1>
        </div>
        <nav class="flex-1 mt-6 space-y-2 px-4">
            <a href="#dashboard" class="sidebar-link active flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-3">Dashboard</span>
            </a>
            <a href="#kampanyalar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-paper-plane w-6 text-center"></i><span class="ml-3">Kampanyalar</span>
            </a>
            <a href="#planlanmis" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-clock w-6 text-center"></i><span class="ml-3">Planlanmış Gönderimler</span>
            </a>
            <a href="#raporlar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-chart-line w-6 text-center"></i><span class="ml-3">Raporlar</span>
            </a>
             <a href="#sablonlar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-file-alt w-6 text-center"></i><span class="ml-3">Şablonlar</span>
            </a>
            <a href="#gruplar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-users w-6 text-center"></i><span class="ml-3">Kişi Grupları</span>
            </a>
            <a href="#ayarlar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-cogs w-6 text-center"></i><span class="ml-3">Ayarlar</span>
            </a>
        </nav>
        <div class="px-4 py-2 border-t border-gray-700">
            <p id="user-id-display" class="text-xs text-gray-500 font-mono truncate" title="Kullanıcı ID">ID: yükleniyor...</p>
            <button id="logout-btn" class="w-full mt-2 bg-red-600 text-white text-sm py-2 rounded-lg transition-colors duration-200 flex items-center justify-center">
                 <i class="fas fa-sign-out-alt mr-2"></i> Çıkış Yap
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content p-6 sm:p-8 hidden">
        <div id="app-content">
            <!-- RENDERED CONTENT WILL BE HERE -->
        </div>
    </main>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-xl text-sm transition-transform transform translate-y-20 opacity-0 z-50">
        <span id="toast-message"></span>
    </div>

<script type="module">
    // --- SUNUCU YAPILANDIRMASI (BURAYI KENDİ BİLGİLERİNİZLE DÜZENLEYİN) ---
    const EVOLUTION_API_URL = "https://evo-2.edu-ai.online";
    const EVOLUTION_API_KEY = "iHAF8gWNA1axdRDY9e98UKpork00dBO2";
    // --- ///////////////////////////////////////////////////////////////// ---

    // Firebase SDK'ları (Sürüm 12.3.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    // --- State Management ---
    const state = {
        db: null, auth: null, storage: null, userId: null,
        appId: 'default-app-id', currentPage: 'dashboard',
        collections: { campaigns: [], templates: [], groups: [], settings: { devices: [] } },
        listeners: {}, isSending: false, sendingCampaignId: null,
        qrPollInterval: null,
        countdownInterval: null,
        currentQrBlobUrl: null
    };

    // --- Toast Notification ---
    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast'), toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl text-sm transition-transform transform translate-y-0 opacity-100 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        setTimeout(() => toast.className = toast.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0'), 3000);
    };

    // --- Modal Manager ---
    const ModalManager = {
        show(config) {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
                    <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full ${config.width || 'max-w-3xl'} transform transition-all scale-95 opacity-0">
                        <div class="flex justify-between items-center p-5 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800">${config.title}</h3>
                            <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                        </div>
                        <div class="p-6 max-h-[70vh] overflow-y-auto">${config.body}</div>
                        ${config.footer ? `<div class="flex justify-end items-center p-4 bg-gray-50 rounded-b-lg space-x-3">${config.footer}</div>` : ''}
                    </div>
                </div>`;
            document.getElementById('modal-close-btn').onclick = this.hide;
            document.getElementById('modal-backdrop').onclick = (e) => { if (e.target.id === 'modal-backdrop') this.hide(); };
            setTimeout(() => {
                const content = document.getElementById('modal-content');
                if (content) { content.classList.replace('scale-95', 'scale-100'); content.classList.replace('opacity-0', 'opacity-100'); }
            }, 10);
            if (config.onReady) config.onReady();
        },
        hide() {
            if (state.qrPollInterval) { clearInterval(state.qrPollInterval); state.qrPollInterval = null; }
            if(state.countdownInterval) { clearInterval(state.countdownInterval); state.countdownInterval = null; }
            if (state.currentQrBlobUrl) {
                URL.revokeObjectURL(state.currentQrBlobUrl);
                state.currentQrBlobUrl = null;
            }
            const backdrop = document.getElementById('modal-backdrop');
            if (backdrop) {
                const content = document.getElementById('modal-content');
                if (content) { content.classList.replace('scale-100', 'scale-95'); content.classList.replace('opacity-100', 'opacity-0'); }
                setTimeout(() => { if (backdrop.parentElement) backdrop.parentElement.innerHTML = '' }, 200);
            }
        },
        confirm(title, message, onConfirm) {
            this.show({
                title: title, body: `<p class="text-gray-600">${message}</p>`,
                footer: `<button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button>
                         <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sil</button>`,
                onReady: () => {
                    document.getElementById('confirm-cancel-btn').onclick = this.hide;
                    document.getElementById('confirm-ok-btn').onclick = () => { onConfirm(); this.hide(); };
                }
            });
        }
    };

    // --- Campaign Sending Logic (REAL) ---
    async function checkAndSendCampaigns() {
        if (state.isSending || !state.userId) return;
        const now = new Date();
        const campaignsToStart = state.collections.campaigns.filter(c => c.status === 'planlandı' && c.schedule?.[0]?.sendTime.toDate() <= now);

        if (campaignsToStart.length > 0) {
            campaignsToStart.sort((a,b) => a.schedule[0].sendTime.toDate() - b.schedule[0].sendTime.toDate());
            await sendCampaign(campaignsToStart[0]);
        }
    }
    
    async function sendCampaign(campaign) {
        if (!campaign || state.isSending) return;
        
        if (!isApiConfigured()) {
            showToast("Lütfen önce API ayarlarınızı yapın.", true);
            await Firestore.update('campaigns', campaign.id, { status: 'durduruldu' });
            return;
        }

        state.isSending = true; state.sendingCampaignId = campaign.id;
        showToast(`'${campaign.name}' kampanyası gönderimi başlıyor.`);
        
        try {
            await Firestore.update('campaigns', campaign.id, { status: 'gönderiliyor' });

            const group = state.collections.groups.find(g => g.id === campaign.groupId);
            const device = (state.collections.settings.devices || []).find(d => d.id === campaign.deviceId);
            const delays = state.collections.settings.delays || { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 };

            if (!group || !device || !device.apiKey) throw new Error("Grup, cihaz veya cihaza ait API anahtarı bulunamadı.");
            
            let sentInCampaign = campaign.sentCount || 0;
            let errorInCampaign = campaign.errorCount || 0;
            const allNumbers = [...group.numbers];
            let numbersSentSoFar = 0;

            for (const scheduleItem of campaign.schedule) {
                 const numbersForThisBatch = allNumbers.slice(numbersSentSoFar, numbersSentSoFar + scheduleItem.count);
                 numbersSentSoFar += numbersForThisBatch.length;

                 const waitTime = scheduleItem.sendTime.toDate() - new Date();
                 if (waitTime > 0) {
                    showToast(`${campaign.name}: Bir sonraki parça için ${Math.round(waitTime/1000)} saniye bekleniyor.`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                 }

                 for(const number of numbersForThisBatch) {
                    const isLongDelay = (sentInCampaign + 1) % delays.trigger === 0;
                    const delay = isLongDelay ? (Math.random() * (delays.longMax - delays.longMin) + delays.longMin) * 1000 : (Math.random() * (delays.max - delays.min) + delays.min) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    try {
                        const endpoint = campaign.imageUrl ? '/message/sendMedia' : '/message/sendText';
                        const url = `${EVOLUTION_API_URL}${endpoint}/${device.instanceName}`;
                        const payload = campaign.imageUrl 
                            ? { number: number, mediaMessage: { media: campaign.imageUrl, caption: campaign.message } }
                            : { number: number, textMessage: { text: campaign.message } };

                        const response = await fetch(url, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json', 'apikey': device.apiKey }, 
                            body: JSON.stringify(payload) 
                        });
                        if(!response.ok) {
                            const errorData = await response.json();
                            throw new Error(`Evolution API Hatası: ${errorData.message || response.status}`);
                        }
                        sentInCampaign++;
                    } catch (e) {
                        console.error(`Gönderim hatası ${number}:`, e);
                        errorInCampaign++;
                    }
                    await Firestore.update('campaigns', campaign.id, { sentCount: sentInCampaign, errorCount: errorInCampaign });
                 }
            }
            
            await Firestore.update('campaigns', campaign.id, { status: 'tamamlandı' });
            showToast(`'${campaign.name}' kampanyası tamamlandı.`);
        } catch (error) {
            console.error("Kampanya Gönderim Hatası:", error);
            showToast(`Kampanya hatası: ${error.message}`, true);
            await Firestore.update('campaigns', campaign.id, { status: 'durduruldu' });
        } finally {
            state.isSending = false; state.sendingCampaignId = null;
        }
    }
    
    // --- Firebase & Data ---
    async function initializeFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyB-qEdprf_5D_1abm3ASMi6ASgyRStrrhc",
                authDomain: "whatsapp-toplu-mesaj-16b42.firebaseapp.com",
                projectId: "whatsapp-toplu-mesaj-16b42",
                storageBucket: "whatsapp-toplu-mesaj-16b42.appspot.com",
                messagingSenderId: "144818282989",
                appId: "1:144818282989:web:5d6cc67376e9ad66af07e4",
                measurementId: "G-EP5CFW3R2L"
            };
            
            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.auth = getAuth(app);
            state.storage = getStorage(app);

            onAuthStateChanged(state.auth, user => {
                if (user) {
                    // User is signed in.
                    if (!state.userId) {
                        state.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID: ${user.uid}`;
                        document.getElementById('user-id-display').title = `Kullanıcı ID: ${user.uid}`;
                        
                        document.getElementById('login-overlay').classList.add('hidden');
                        document.getElementById('sidebar').classList.remove('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        
                        setupRealtimeListeners();
                        setInterval(checkAndSendCampaigns, 30 * 1000); 

                        window.addEventListener('hashchange', handleNavigation);
                        handleNavigation(); 
                    }
                } else {
                    // User is signed out.
                    state.userId = null;
                    document.getElementById('login-overlay').classList.remove('hidden');
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    Object.values(state.listeners).forEach(unsubscribe => unsubscribe());
                    state.listeners = {};
                }
            });

        } catch (error) { 
            console.error("Firebase Hatası:", error); 
            showToast(`Firebase başlatılamadı: ${error.message}`, true); 
        }
    }
    
    const handleEmailLogin = async () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            showToast("Lütfen e-posta ve şifreyi girin.", true);
            return;
        }
        try {
            await signInWithEmailAndPassword(state.auth, email, password);
        } catch (error) {
            console.error("Giriş hatası:", error);
            showToast(`Giriş başarısız: ${error.message}`, true);
        }
    };

    const handleEmailSignUp = async () => {
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        if (!email || !password) {
            showToast("Lütfen e-posta ve şifreyi girin.", true);
            return;
        }
        try {
            await createUserWithEmailAndPassword(state.auth, email, password);
        } catch (error) {
            console.error("Hesap oluşturma hatası:", error);
            showToast(`Hesap oluşturulamadı: ${error.message}`, true);
        }
    };

    const handleLogout = async () => {
        try {
            await signOut(state.auth);
            showToast("Başarıyla çıkış yapıldı.");
        } catch (error) {
            console.error("Çıkış hatası:", error);
            showToast(`Çıkış yapılamadı: ${error.message}`, true);
        }
    };


    function setupRealtimeListeners() {
        const collectionsToListen = ['campaigns', 'templates', 'groups'];
        collectionsToListen.forEach(name => {
            try {
                if (state.listeners[name]) state.listeners[name]();
                const q = query(collection(state.db, "users", state.userId, name), orderBy('createdAt', 'desc'));
                state.listeners[name] = onSnapshot(q, (snapshot) => {
                    state.collections[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCurrentPage();
                }, (error) => console.error(`${name} dinlenirken hata:`, error));
            } catch (error) { console.error(`Listener setup error for ${name}:`, error); }
        });

        try {
            if (state.listeners.settings) state.listeners.settings();
            const settingsDocRef = doc(state.db, "users", state.userId, "app_settings/main");
            state.listeners.settings = onSnapshot(settingsDocRef, (docSnap) => {
                if(docSnap.exists()){
                    state.collections.settings = docSnap.data();
                } else {
                    const defaultSettings = {
                        devices: [],
                        delays: { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 }
                    };
                    setDoc(settingsDocRef, defaultSettings);
                    state.collections.settings = defaultSettings;
                }
                renderCurrentPage();
            }, (error) => console.error('Ayarlar dinlenirken hata:', error));

        } catch (error) { console.error(`Settings listener setup error:`, error); }
    }
    
    const Firestore = {
        async add(coll, data) {
            try {
                const docRef = await addDoc(collection(state.db, "users", state.userId, coll), { ...data, createdAt: serverTimestamp() });
                showToast(`${coll.slice(0, -1)} başarıyla eklendi.`);
                return docRef.id;
            } catch (error) { console.error("Firestore Add Error:", error); showToast(`Ekleme hatası: ${error.message}`, true); return null; }
        },
        async update(coll, id, data) {
            try {
                await updateDoc(doc(state.db, "users", state.userId, coll, id), data);
                showToast(`${coll.slice(0, -1)} başarıyla güncellendi.`); return true;
            } catch (error) { console.error("Firestore Update Error:", error); showToast(`Güncelleme hatası: ${error.message}`, true); return false; }
        },
        async delete(coll, id) {
            try {
                await deleteDoc(doc(state.db, "users", state.userId, coll, id));
                showToast(`${coll.slice(0, -1)} başarıyla silindi.`); return true;
            } catch (error) { console.error("Firestore Delete Error:", error); showToast(`Silme hatası: ${error.message}`, true); return false; }
        },
        async updateSettings(data) {
             try {
                await setDoc(doc(state.db, "users", state.userId, "app_settings/main"), data, { merge: true });
                return true;
            } catch (error) { console.error("Firestore Settings Update Error:", error); showToast(`Ayarları güncelleme hatası: ${error.message}`, true); return false; }
        }
    };
    
    // --- UI Rendering ---
    const appContent = document.getElementById('app-content');
    const pageRenderers = { dashboard: renderDashboard, kampanyalar: renderCampaigns, planlanmis: renderPlanlanmis, raporlar: renderRaporlar, sablonlar: renderTemplates, gruplar: renderGroups, ayarlar: renderSettings };

    function renderPage(title, buttonHtml, contentHtml) { appContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">${title}</h2><div>${buttonHtml}</div></div><div class="bg-white rounded-lg shadow-md"><div class="overflow-x-auto">${contentHtml}</div></div>`; }
    function createStatCard(title, value, color) { return `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">${title}</p><p class="text-3xl font-bold ${color}">${value}</p></div>`; }
    function renderDashboard() {
        const { campaigns } = state.collections;
        const stats = campaigns.reduce((acc, c) => ({ ...acc, [c.status]: (acc[c.status] || 0) + 1 }), { total: campaigns.length });
        appContent.innerHTML = `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${createStatCard('Toplam Kampanya', stats.total || 0, 'text-gray-800')}
                ${createStatCard('Planlanmış', stats['planlandı'] || 0, 'text-blue-600')}
                ${createStatCard('Gönderiliyor', stats['gönderiliyor'] || 0, 'text-amber-600')}
                ${createStatCard('Tamamlananlar', stats['tamamlandı'] || 0, 'text-green-600')}
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mt-8"><h3 class="font-semibold text-gray-800 mb-4">Son Kampanyalar</h3><ul class="space-y-3">${campaigns.slice(0, 5).map(c => `
                <li class="flex justify-between items-center text-sm"><span class="text-gray-700">${c.name}</span><span class="status-badge status-${c.status || 'taslak'}">${c.status || 'taslak'}</span></li>`).join('') || '<p class="text-sm text-gray-500">Henüz kampanya yok.</p>'}</ul>
            </div>`;
    }

    function renderDetailsButton(campaign) {
        return `<button data-id="${campaign.id}" class="details-btn text-gray-500 hover:text-gray-700"><i class="fas fa-eye"></i></button>`;
    }
    
    function renderCampaignRow(c) {
        const group = state.collections.groups.find(g => g.id === c.groupId);
        const totalNumbers = group ? group.numbers.length : 1;
        const progress = (c.sentCount / totalNumbers) * 100;
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900">
                    <div>${c.name}</div>
                    ${(c.status === 'gönderiliyor' || c.status === 'tamamlandı') && totalNumbers > 0 ? `<div class="mt-1"><div class="progress-bar"><div class="progress-bar-inner" style="width: ${progress}%"></div></div></div>` : ''}
                </td>
                <td class="px-6 py-4">${group?.name || 'Grup Yok'} (${group?.numbers.length || 0} kişi)</td>
                <td class="px-6 py-4"><span class="status-badge status-${c.status}">${c.status}</span></td>
                <td class="px-6 py-4 text-right space-x-2">
                    ${renderDetailsButton(c)}
                    <button data-id="${c.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                    <button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
    }

    function renderCampaigns() {
        const button = `<button id="new-campaign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Kampanya</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adı</th><th class="px-6 py-3">Hedef Grup</th><th class="px-6 py-3">Durum</th><th class="px-6 py-3 text-right">İşlemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.collections.campaigns.map(renderCampaignRow).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">Henüz kampanya yok.</td></tr>'}</tbody></table>`;
        renderPage('Tüm Kampanyalar', button, table);
        document.getElementById('new-campaign-btn').onclick = () => showCampaignModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showCampaignModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayı Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
    }
     function renderPlanlanmis() {
        const plannedCampaigns = state.collections.campaigns.filter(c => c.status === 'planlandı');
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adı</th><th class="px-6 py-3">Gönderim Tipi</th><th class="px-6 py-3">İlk Gönderim</th><th class="px-6 py-3 text-right">İşlemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${plannedCampaigns.map(c => {
            const firstSend = c.schedule?.[0]?.sendTime;
            return `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${c.name}</td><td class="px-6 py-4 capitalize">${c.sendType}</td><td class="px-6 py-4">${firstSend ? new Date(firstSend.toDate()).toLocaleString('tr-TR') : 'Belirsiz'}</td><td class="px-6 py-4 text-right space-x-2">${renderDetailsButton(c)}<button data-id="${c.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">Planlanmış kampanya yok.</td></tr>'}</tbody></table>`;
        renderPage('Planlanmış Gönderimler', '', table);
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showCampaignModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayı Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
    }
    function renderRaporlar() {
        const reportedCampaigns = state.collections.campaigns.filter(c => c.status === 'tamamlandı' || c.status === 'durduruldu');
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adı</th><th class="px-6 py-3">Durum</th><th class="px-6 py-3">Gönderilen / Hatalı</th><th class="px-6 py-3 text-right">İşlemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${reportedCampaigns.map(c => `
            <tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${c.name}</td><td class="px-6 py-4"><span class="status-badge status-${c.status}">${c.status}</span></td><td class="px-6 py-4">${c.sentCount || 0} / ${c.errorCount || 0}</td><td class="px-6 py-4 text-right">${renderDetailsButton(c)}</td></tr>`
        ).join('') || '<tr><td colspan="4" class="text-center py-4 text-gray-500">Raporlanacak kampanya yok.</td></tr>'}</tbody></table>`;
        renderPage('Raporlar', '', table);
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
    }
    function renderTemplates() {
        const button = `<button id="new-template-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Şablon</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Şablon Adı</th><th class="px-6 py-3">İçerik</th><th class="px-6 py-3 text-right">İşlemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.collections.templates.map(t => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${t.name}</td><td class="px-6 py-4 text-gray-500 truncate" style="max-width: 300px;">${t.content}</td><td class="px-6 py-4 text-right space-x-2"><button data-id="${t.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-500">Henüz şablon yok.</td></tr>'}</tbody></table>`;
        renderPage('Mesaj Şablonları', button, table);
        document.getElementById('new-template-btn').onclick = () => showTemplateModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showTemplateModal(state.collections.templates.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Şablonu Sil', 'Emin misiniz?', () => Firestore.delete('templates', btn.dataset.id)));
    }
    function renderGroups() {
        const button = `<button id="new-group-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Grup</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Grup Adı</th><th class="px-6 py-3">Kişi Sayısı</th><th class="px-6 py-3 text-right">İşlemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.collections.groups.map(g => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${g.name}</td><td class="px-6 py-4">${g.numbers.length}</td><td class="px-6 py-4 text-right space-x-2"><button data-id="${g.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${g.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-500">Henüz grup yok.</td></tr>'}</tbody></table>`;
        renderPage('Kişi Grupları', button, table);
        document.getElementById('new-group-btn').onclick = () => showGroupModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showGroupModal(state.collections.groups.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Grubu Sil', 'Emin misiniz?', () => Firestore.delete('groups', btn.dataset.id)));
    }
    function renderSettings() {
        const { devices = [], delays = { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 } } = state.collections.settings;
        const content = `
            <div class="p-6 space-y-8">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Cihaz Yönetimi</h3>
                    <div class="bg-gray-50 p-4 rounded-md border border-gray-200 space-y-3" id="devices-container">
                        ${devices.length > 0 ? devices.map(renderDeviceCard).join('') : '<p class="text-sm text-gray-500 text-center">Henüz cihaz bağlanmamış.</p>'}
                    </div>
                    <button id="add-device-btn" class="mt-4 text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Cihaz Bağla</button>
                </div>
                <div class="border-t pt-6">
                     <h3 class="text-lg font-semibold text-gray-800 mb-3">Genel Gönderim Ayarları</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div><label class="block text-sm font-medium">Min Bekleme (sn)</label><input type="number" id="delay-min" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.min}"></div>
                        <div><label class="block text-sm font-medium">Max Bekleme (sn)</label><input type="number" id="delay-max" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.max}"></div>
                        <div><label class="block text-sm font-medium">Uzun Bekleme Tetikleyicisi</label><input type="number" id="delay-trigger" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.trigger}"></div>
                        <div><label class="block text-sm font-medium">Min Uzun Bekleme (sn)</label><input type="number" id="delay-long-min" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.longMin}"></div>
                        <div><label class="block text-sm font-medium">Max Uzun Bekleme (sn)</label><input type="number" id="delay-long-max" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.longMax}"></div>
                     </div>
                </div>
            </div>`;
        renderPage('Ayarlar', `<button id="save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Gönderim Ayarlarını Kaydet</button>`, content);
        
        document.getElementById('add-device-btn').onclick = () => showAddDeviceModal();
        appContent.querySelectorAll('.delete-device-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Cihazı Sil', 'Bu cihazı silmek istediğinizden emin misiniz?', () => saveDevices(devices.filter(d => d.id != btn.dataset.id))));
        appContent.querySelectorAll('.connect-device-btn').forEach(btn => btn.onclick = () => connectDevice(devices.find(d => d.id == btn.dataset.id)));
        appContent.querySelectorAll('.disconnect-device-btn').forEach(btn => btn.onclick = () => disconnectDevice(devices.find(d => d.id == btn.dataset.id)));

        document.getElementById('save-settings-btn').onclick = async (e) => {
            const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Kaydediliyor...';
            const newDelays = {
                min: parseInt(document.getElementById('delay-min').value), max: parseInt(document.getElementById('delay-max').value),
                trigger: parseInt(document.getElementById('delay-trigger').value), longMin: parseInt(document.getElementById('delay-long-min').value),
                longMax: parseInt(document.getElementById('delay-long-max').value),
            };
            if (await Firestore.updateSettings({ delays: newDelays })) {
                showToast("Gönderim ayarları kaydedildi.");
            }
            btn.disabled = false; btn.textContent = 'Gönderim Ayarlarını Kaydet';
        };
    }

    function renderDeviceCard(device) {
        const statusMap = { connected: 'device-connected', disconnected: 'device-disconnected', connecting: 'device-connecting' };
        const statusTextMap = { connected: 'Bağlandı', disconnected: 'Bağlı Değil', connecting: 'Bağlanıyor' };
        const statusClass = statusMap[device.status] || 'device-disconnected';
        const statusText = statusTextMap[device.status] || 'Bilinmiyor';

        return `
            <div class="bg-white p-4 rounded-lg border border-gray-200 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-mobile-alt text-2xl text-gray-500"></i>
                    <div>
                        <p class="font-semibold text-gray-800">${device.cihazAdi}</p>
                        <p class="text-sm text-gray-600">${device.phone || 'Numara Yok'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="device-status ${statusClass}">${statusText}</span>
                    <div class="flex gap-2">
                        ${device.status !== 'connected' ? `<button data-id="${device.id}" class="connect-device-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-md">Bağlan</button>` : ''}
                        ${device.status === 'connected' ? `<button data-id="${device.id}" class="disconnect-device-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-md">Bağlantıyı Kes</button>` : ''}
                        <button data-id="${device.id}" class="delete-device-btn text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>`;
    }

    // --- Modal Show Functions ---
     function showCampaignModal(campaign = null) {
        const isEdit = !!campaign;
        const groupsOptions = state.collections.groups.map(g => `<option value="${g.id}" ${isEdit && g.id === campaign.groupId ? 'selected' : ''}>${g.name}</option>`).join('');
        const accountsOptions = (state.collections.settings.devices || []).map(d => `<option value="${d.id}" ${isEdit && d.id === campaign.deviceId ? 'selected' : ''}>${d.cihazAdi} (${d.phone})</option>`).join('');
        const templatesOptions = state.collections.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        ModalManager.show({
            title: isEdit ? 'Kampanyayı Düzenle' : 'Yeni Kampanya Oluştur',
            body: `<div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Kampanya Adı</label><input type="text" id="campaign-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${campaign?.name || ''}"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">Gönderici Cihaz</label><select id="campaign-device" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${accountsOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Hedef Kişi Grubu</label><select id="campaign-group" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">-- Grup Seç --</option>${groupsOptions}</select><span id="group-count" class="text-xs text-gray-500 mt-1"></span></div>
                </div>
                 <div><label class="block text-sm font-medium text-gray-700">Mesaj Şablonu</label><select id="campaign-template-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">-- Şablon Seç --</option>${templatesOptions}</select></div>
                <div><label class="block text-sm font-medium text-gray-700">Mesaj İçeriği</label><textarea id="campaign-message" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="4">${campaign?.message || ''}</textarea></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Görsel Ekle (Opsiyonel)</label>
                    <input type="file" id="campaign-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <div id="image-preview-container" class="mt-2">${campaign?.imageUrl ? `<img src="${campaign.imageUrl}" class="max-h-32 rounded-md shadow-sm">` : ''}</div>
                </div>
                <div class="border-t pt-4 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Gönderim Tipi</label>
                    <div class="flex space-x-4">
                        <div class="flex items-center"><input type="radio" id="send-now" name="sendType" value="now" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${(!isEdit || campaign?.sendType === 'now') ? 'checked' : ''}><label for="send-now" class="ml-2 block text-sm text-gray-900">Hemen Gönder</label></div>
                        <div class="flex items-center"><input type="radio" id="send-later" name="sendType" value="later" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${isEdit && campaign?.sendType === 'later' ? 'checked' : ''}><label for="send-later" class="ml-2 block text-sm text-gray-900">İleri Tarihli Gönder</label></div>
                        <div class="flex items-center"><input type="radio" id="send-split" name="sendType" value="split" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${isEdit && campaign?.sendType === 'split' ? 'checked' : ''}><label for="send-split" class="ml-2 block text-sm text-gray-900">Parçalara Bölerek Gönder</label></div>
                    </div>
                    <div id="send-later-container" class="hidden"><input type="datetime-local" id="send-later-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div id="send-split-container" class="hidden mt-4 space-y-3"></div>
                    <div id="split-summary" class="text-sm text-gray-600 mt-2"></div>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${isEdit ? 'Güncelle' : 'Oluştur'}</button>`,
            onReady: () => {
                const groupSelect = document.getElementById('campaign-group');
                const groupCountSpan = document.getElementById('group-count');
                const splitContainer = document.getElementById('send-split-container');
                const laterContainer = document.getElementById('send-later-container');
                const splitSummary = document.getElementById('split-summary');
                let groupNumbersCount = 0;

                document.getElementById('campaign-image').onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('image-preview-container').innerHTML = `<img src="${event.target.result}" class="max-h-32 rounded-md shadow-sm">`;
                        };
                        reader.readAsDataURL(file);
                    }
                };

                const updateSendTypeUI = () => {
                    const selectedType = document.querySelector('input[name="sendType"]:checked').value;
                    laterContainer.style.display = selectedType === 'later' ? 'block' : 'none';
                    splitContainer.style.display = selectedType === 'split' ? 'block' : 'none';
                    if (selectedType === 'split' && splitContainer.innerHTML.trim() === '') {
                        renderSplitter(campaign?.schedule);
                    }
                };
                
                const updateGroupCount = () => {
                    const selectedGroup = state.collections.groups.find(g => g.id === groupSelect.value);
                    groupNumbersCount = selectedGroup ? selectedGroup.numbers.length : 0;
                    groupCountSpan.textContent = selectedGroup ? `${groupNumbersCount} kişi` : '';
                    updateSplitSummary();
                };
                groupSelect.onchange = updateGroupCount;

                document.getElementById('campaign-template-select').onchange = (e) => {
                    const selectedTemplate = state.collections.templates.find(t => t.id === e.target.value);
                    if(selectedTemplate) document.getElementById('campaign-message').value = selectedTemplate.content;
                };

                const renderSplitter = (schedule = []) => {
                    splitContainer.innerHTML = `<div id="split-rows"></div><button id="add-split-row" type="button" class="text-sm text-blue-600 hover:text-blue-800">+ Parça Ekle</button>`;
                    const rowsContainer = document.getElementById('split-rows');
                    (schedule.length > 0 ? schedule : [{ count: 0, sendTime: null }]).forEach(item => {
                         const time = item.sendTime ? new Date(item.sendTime.toDate().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
                         rowsContainer.insertAdjacentHTML('beforeend', createSplitRow(item.count, time));
                    });
                    document.getElementById('add-split-row').onclick = () => {
                         if (calculateTotalSplitCount() < groupNumbersCount) {
                            rowsContainer.insertAdjacentHTML('beforeend', createSplitRow());
                         } else {
                            showToast("Grup kapasitesine ulaşıldı, yeni parça eklenemez.", true);
                         }
                    };
                    splitContainer.addEventListener('input', updateSplitSummary);
                };
                
                const createSplitRow = (count = 0, time = '') => `
                    <div class="split-row flex items-center gap-2">
                        <input type="datetime-local" class="split-time border border-gray-300 rounded-md p-1.5 w-1/2" value="${time}">
                        <input type="number" placeholder="Kişi Sayısı" class="split-count border border-gray-300 rounded-md p-1.5 w-1/2" value="${count}">
                        <button type="button" class="remove-split-row text-red-500 p-1"><i class="fas fa-times"></i></button>
                    </div>`;
                
                splitContainer.addEventListener('click', e => {
                    if(e.target.closest('.remove-split-row')) {
                        e.target.closest('.split-row').remove();
                        updateSplitSummary();
                    }
                });

                const calculateTotalSplitCount = () => Array.from(splitContainer.querySelectorAll('.split-count')).reduce((sum, el) => sum + (parseInt(el.value) || 0), 0);
                
                const updateSplitSummary = () => {
                    const total = calculateTotalSplitCount();
                    splitSummary.textContent = `Planlanan: ${total} / ${groupNumbersCount} kişi`;
                    splitSummary.style.color = total > groupNumbersCount ? 'red' : 'inherit';
                };
                
                if(isEdit) {
                    updateGroupCount();
                    if (campaign.sendType === 'later' && campaign.schedule?.[0]?.sendTime) {
                        const d = campaign.schedule[0].sendTime.toDate();
                        document.getElementById('send-later-time').value = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                    }
                }
                updateSendTypeUI();
                document.querySelectorAll('input[name="sendType"]').forEach(radio => radio.onchange = updateSendTypeUI);
                
                 document.getElementById('modal-save-btn').onclick = async (e) => {
                    const saveBtn = e.currentTarget;
                    saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                    
                    try {
                        let imageUrl = campaign?.imageUrl || '';
                        const imageFile = document.getElementById('campaign-image').files[0];
                        if (imageFile) {
                            const storageRef = ref(state.storage, `users/${state.userId}/campaign_images/${Date.now()}_${imageFile.name}`);
                            const snapshot = await uploadBytes(storageRef, imageFile);
                            imageUrl = await getDownloadURL(snapshot.ref);
                        }

                        const sendType = document.querySelector('input[name="sendType"]:checked').value;
                        const schedule = [];
                        let validationError = null;
                        const selectedGroup = state.collections.groups.find(g => g.id === groupSelect.value);
                        const groupSize = selectedGroup ? selectedGroup.numbers.length : 0;

                        if(sendType === 'later'){
                            const laterTime = document.getElementById('send-later-time').value;
                            if(!laterTime) validationError = "Lütfen ileri tarihli gönderim için bir zaman seçin.";
                            else schedule.push({ count: groupSize, sendTime: Timestamp.fromDate(new Date(laterTime)) });
                        } else if (sendType === 'now'){
                             schedule.push({ count: groupSize, sendTime: Timestamp.now() });
                        } else if (sendType === 'split'){
                            const totalSplit = calculateTotalSplitCount();
                            if(totalSplit > groupSize) validationError = "Planlanan kişi sayısı grup mevcudunu aşıyor.";
                            if(totalSplit < groupSize) validationError = "Lütfen gruptaki tüm kişileri planlayın.";
                            
                            document.querySelectorAll('.split-row').forEach(row => {
                                const time = row.querySelector('.split-time').value;
                                const count = parseInt(row.querySelector('.split-count').value);
                                if(!time || !count || count <= 0) validationError = "Lütfen tüm parçalar için zaman ve geçerli kişi sayısı girin.";
                                schedule.push({ count: count, sendTime: Timestamp.fromDate(new Date(time)) });
                            });
                            if (schedule.length === 0) validationError = "Lütfen en az bir gönderim parçası ekleyin.";
                        }

                        const data = {
                            name: document.getElementById('campaign-name').value.trim(),
                            deviceId: document.getElementById('campaign-device').value,
                            groupId: document.getElementById('campaign-group').value,
                            message: document.getElementById('campaign-message').value.trim(),
                            sendType: sendType,
                            schedule: schedule.sort((a,b) => a.sendTime - b.sendTime), 
                            status: 'planlandı',
                            sentCount: campaign?.sentCount || 0,
                            errorCount: campaign?.errorCount || 0,
                            imageUrl: imageUrl
                        };

                        if(!data.name || !data.deviceId || !data.groupId || !data.message) validationError = "Lütfen tüm zorunlu alanları doldurun.";
                        if(validationError) throw new Error(validationError);

                        const success = isEdit ? await Firestore.update('campaigns', campaign.id, data) : await Firestore.add('campaigns', data);
                        if (success) ModalManager.hide();
                        else throw new Error("Firestore kaydetme işlemi başarısız oldu.");

                    } catch (error) {
                         console.error("Save campaign error:", error);
                         showToast(`Kaydetme hatası: ${error.message}`, true);
                    } finally {
                        saveBtn.disabled = false; saveBtn.textContent = isEdit ? 'Güncelle' : 'Oluştur';
                    }
                };
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
            }
        });
    }

    function showCampaignDetailsModal(campaign) { 
        const group = state.collections.groups.find(g => g.id === campaign.groupId);
        const device = (state.collections.settings.devices || []).find(d => d.id === campaign.deviceId);
        
        let scheduleHtml = campaign.schedule.map(s => `<li>${new Date(s.sendTime.toDate()).toLocaleString('tr-TR')} - <strong>${s.count}</strong> kişi</li>`).join('');

        const body = `
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                <div class="col-span-1"><dt class="font-medium text-gray-500">Cihaz</dt><dd class="mt-1 text-gray-900">${device?.cihazAdi || 'N/A'}</dd></div>
                <div class="col-span-1"><dt class="font-medium text-gray-500">Grup</dt><dd class="mt-1 text-gray-900">${group?.name || 'N/A'} (${group?.numbers.length || 0} kişi)</dd></div>
                <div class="col-span-2"><dt class="font-medium text-gray-500">Mesaj İçeriği</dt><dd class="mt-1 text-gray-900 whitespace-pre-wrap">${campaign.message}</dd></div>
                ${campaign.imageUrl ? `<div class="col-span-2"><dt class="font-medium text-gray-500">Görsel</dt><dd class="mt-1"><img src="${campaign.imageUrl}" class="max-h-40 rounded shadow"></dd></div>` : ''}
                <div class="col-span-2"><dt class="font-medium text-gray-500">Gönderim Planı</dt><dd class="mt-1 text-gray-900"><ul>${scheduleHtml}</ul></dd></div>
            </dl>`;
        ModalManager.show({ title: campaign.name, body: body, footer: `<button id="modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Kapat</button>`, onReady: () => document.getElementById('modal-close').onclick = ModalManager.hide });
    }
    
    function showTemplateModal(template = null) {
        const isEdit = !!template;
        ModalManager.show({
            title: isEdit ? 'Şablonu Düzenle' : 'Yeni Şablon',
            body: `<div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Şablon Adı</label><input type="text" id="template-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${template?.name || ''}"></div>
                <div><label class="block text-sm font-medium text-gray-700">İçerik</label><textarea id="template-content" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="5">${template?.content || ''}</textarea></div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const data = { name: document.getElementById('template-name').value.trim(), content: document.getElementById('template-content').value.trim() };
                    if(!data.name || !data.content) { showToast("Lütfen tüm alanları doldurun.", true); return; }
                    const success = isEdit ? await Firestore.update('templates', template.id, data) : await Firestore.add('templates', data);
                    if(success) ModalManager.hide();
                };
            }
        });
    }

    function showGroupModal(group = null) {
        const isEdit = !!group;
        ModalManager.show({
            title: isEdit ? 'Grubu Düzenle' : 'Yeni Grup',
            body: `<div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Grup Adı</label><input type="text" id="group-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${group?.name || ''}"></div>
                <div><label class="block text-sm font-medium text-gray-700">Telefon Numaraları (her biri yeni satırda)</label><textarea id="group-numbers" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="8">${group?.numbers?.join('\\n') || ''}</textarea></div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const name = document.getElementById('group-name').value.trim();
                    const numbers = document.getElementById('group-numbers').value.trim().split(/\\s*\\n\\s*/).filter(n => n);
                    if(!name || numbers.length === 0) { showToast("Lütfen grup adı ve en az bir numara girin.", true); return; }
                    const data = { name, numbers };
                    const success = isEdit ? await Firestore.update('groups', group.id, data) : await Firestore.add('groups', data);
                    if(success) ModalManager.hide();
                };
            }
        });
    }
    
    function showAddDeviceModal() {
        ModalManager.show({
            title: 'Yeni Cihaz Bağla',
            width: 'max-w-md',
            body: `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cihaz Adı</label>
                    <input type="text" id="device-friendly-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="örn: Satış Destek Hattı">
                    <p class="text-xs text-gray-500 mt-1">Bu cihaza vermek istediğiniz kolay anlaşılır bir isim girin.</p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Bağlanacak WhatsApp Numarası</label>
                    <input type="text" id="device-phone-number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="905551234567">
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet ve QR Kodu Al</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const cihazAdi = document.getElementById('device-friendly-name').value.trim();
                    const phone = document.getElementById('device-phone-number').value.trim();
                    if (!cihazAdi || !phone) {
                        showToast("Lütfen tüm alanları doldurun.", true); return;
                    }

                    const sanitizedName = cihazAdi.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, "").replace(/-+/g, '-').replace(/^-+|-+$/g, '').toLowerCase();
                    if (!sanitizedName) {
                        showToast("Geçerli bir cihaz adı girin (sadece harf ve rakam).", true); return;
                    }

                    const instanceName = `${state.userId.slice(0, 8)}-${sanitizedName}-${Date.now().toString().slice(-5)}`;
                    
                    const newDevice = {
                        id: Date.now().toString(),
                        cihazAdi: cihazAdi,
                        phone: phone,
                        instanceName: instanceName,
                        status: 'disconnected',
                        apiKey: '' // Will be filled after creation
                    };
                    
                    ModalManager.hide();
                    connectDevice(newDevice, true); // Pass true for isNew
                };
            }
        });
    }

    // --- EVOLUTION API INTEGRATION ---
    function isApiConfigured() {
        if (EVOLUTION_API_URL.includes("SİZİN_EVO_API_ADRESİNİZ") || EVOLUTION_API_KEY.includes("SİZİN_GENEL_EVO_API_ANAHTARINIZ")) {
            showToast("Lütfen kodun en başındaki sunucu ve API anahtarı bilgilerini güncelleyin.", true);
            return false;
        }
        return true;
    }

    async function saveDevices(newDevices) {
        if (await Firestore.updateSettings({ devices: newDevices })) {
            showToast("Cihaz listesi güncellendi.");
        }
    }

    function base64ToBlobUrl(base64Data) {
        try {
            // Strip off the data URI scheme if it exists
            const base64String = base64Data.split(',')[1] || base64Data;
            const byteCharacters = atob(base64String);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {type: 'image/png'});
            return URL.createObjectURL(blob);
        } catch (e) {
            console.error("Base64 to Blob conversion failed:", e);
            return null;
        }
    }


    async function connectDevice(device, isNew = false) {
        if (!isApiConfigured()) return;
        
        // Clear previous intervals if any
        if (state.countdownInterval) clearInterval(state.countdownInterval);
        if (state.qrPollInterval) clearInterval(state.qrPollInterval);

        ModalManager.show({
            title: `Cihaz Bağlanıyor: ${device.cihazAdi}`,
            width: 'max-w-md',
            body: `<div id="qr-container" class="text-center p-4"><div class="fas fa-spinner fa-spin text-4xl text-gray-500"></div><p class="mt-4 text-gray-600">WhatsApp'tan QR kod bekleniyor...</p></div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">İptal</button>`
        });
        document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
        
        const qrContainer = document.getElementById('qr-container');

        const startCountdown = () => {
            let timeLeft = 60;
            const timerElement = document.createElement('p');
            timerElement.className = "mt-2 text-sm text-gray-500";
            qrContainer.appendChild(timerElement);

            state.countdownInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timerElement.textContent = `Bu kod ${timeLeft} saniye içinde zaman aşımına uğrayacak.`;
                    timeLeft--;
                } else {
                    clearInterval(state.countdownInterval);
                    clearInterval(state.qrPollInterval);
                    state.qrPollInterval = null;
                    qrContainer.innerHTML = `
                        <p class="text-red-500 font-medium">QR Kodu zaman aşımına uğradı.</p>
                        <button id="refresh-qr-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i> Yeni Kod Al
                        </button>
                    `;
                    document.getElementById('refresh-qr-btn').onclick = () => connectDevice(device, false);
                }
            }, 1000);
        };

        const updateQrDisplay = (base64) => {
            if (state.currentQrBlobUrl) URL.revokeObjectURL(state.currentQrBlobUrl);
            
            const blobUrl = base64ToBlobUrl(base64);
            if (blobUrl) {
                state.currentQrBlobUrl = blobUrl;
                qrContainer.innerHTML = `
                    <img src="${blobUrl}" class="mx-auto" alt="QR Kodu Yüklenemedi">
                    <p class="mt-4 text-gray-600">Lütfen WhatsApp ile QR kodu okutun.</p>
                `;
                if (state.countdownInterval) clearInterval(state.countdownInterval);
                startCountdown();
            } else {
                qrContainer.innerHTML = `<p class="text-red-500">QR Kodu oluşturulamadı.</p>`;
            }
        };

        try {
            const createRes = await fetch(`${EVOLUTION_API_URL}/instance/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': EVOLUTION_API_KEY },
                body: JSON.stringify({ 
                    instanceName: device.instanceName, 
                    number: device.phone,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS"
                })
            });

            const createData = await createRes.json();
            
            if(!createRes.ok && createRes.status !== 409) {
                let errorDetails = `HTTP Durum Kodu: ${createRes.status}`;
                try {
                    errorDetails = createData.message || JSON.stringify(createData.response || createData);
                } catch (e) {
                   errorDetails = await createRes.text();
                }
                throw new Error(`Instance oluşturulamadı. Detay: ${errorDetails}`);
            }

            if (createData.qrcode && createData.qrcode.base64) {
                 updateQrDisplay(createData.qrcode.base64);
            }

            if (isNew && createData.hash && createData.hash.apikey) {
                device.apiKey = createData.hash.apikey;
                const currentDevices = state.collections.settings.devices || [];
                await saveDevices([...currentDevices, device]);
            }
            
            let lastBase64 = createData.qrcode?.base64 || '';

            state.qrPollInterval = setInterval(async () => {
                try {
                    const connRes = await fetch(`${EVOLUTION_API_URL}/instance/connectionState/${device.instanceName}`, { headers: { 'apikey': EVOLUTION_API_KEY } });
                    const connData = await connRes.json();
                    
                    if (!document.getElementById('qr-container')) {
                        clearInterval(state.qrPollInterval); 
                        clearInterval(state.countdownInterval);
                        return;
                    }

                    if (connData.state === 'open') {
                        clearInterval(state.qrPollInterval);
                        clearInterval(state.countdownInterval);
                        const updatedDevices = (state.collections.settings.devices || []).map(d => d.id === device.id ? { ...d, status: 'connected' } : d);
                        await saveDevices(updatedDevices);
                        ModalManager.hide();
                        showToast(`${device.cihazAdi} başarıyla bağlandı!`);
                    } else {
                        const qrRes = await fetch(`${EVOLUTION_API_URL}/instance/connect/${device.instanceName}`, { headers: { 'apikey': EVOLUTION_API_KEY } });
                        const qrData = await qrRes.json();
                        
                        if (qrData.base64 && qrData.base64 !== lastBase64) {
                            lastBase64 = qrData.base64;
                            updateQrDisplay(qrData.base64);
                        } else if(connData.state === 'connecting' && !qrContainer.querySelector('.fa-spinner')){
                            clearInterval(state.countdownInterval);
                            qrContainer.innerHTML = `<div class="fas fa-spinner fa-spin text-4xl text-gray-500"></div><p class="mt-4 text-gray-600">Bağlantı kuruluyor, lütfen bekleyin...</p>`;
                        }
                    }
                } catch(pollError) {
                    console.error("Polling error:", pollError);
                    clearInterval(state.qrPollInterval);
                    clearInterval(state.countdownInterval);
                }
            }, 5000);

        } catch (error) {
            console.error("Connection error:", error);
            showToast(`Bağlantı hatası: ${error.message}`, true);
            ModalManager.hide();
        }
    }

    async function disconnectDevice(device) {
        if (!isApiConfigured()) return;
        try {
            const response = await fetch(`${EVOLUTION_API_URL}/instance/logout/${device.instanceName}`, {
                method: 'DELETE',
                headers: { 'apikey': EVOLUTION_API_KEY }
            });
            if (!response.ok) throw new Error(`Bağlantı kesilemedi: ${response.status}`);
            const updatedDevices = state.collections.settings.devices.map(d => d.id === device.id ? { ...d, status: 'disconnected' } : d);
            await saveDevices(updatedDevices);
            showToast("Cihaz bağlantısı kesildi.");
        } catch (error) {
            console.error("Disconnect error:", error);
            showToast(`Hata: ${error.message}`, true);
        }
    }

    // --- Navigation & Init ---
    function renderCurrentPage() {
        if (!state.userId) return;
        const pageKey = window.location.hash.substring(1) || 'dashboard';
        if (pageRenderers[pageKey]) pageRenderers[pageKey]();
        else pageRenderers['dashboard']();
    }
    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'dashboard';
        state.currentPage = hash;
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.toggle('active', link.getAttribute('href') === `#${hash}`);
        });
        renderCurrentPage();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeFirebase();
        document.getElementById('login-btn').addEventListener('click', handleEmailLogin);
        document.getElementById('signup-btn').addEventListener('click', handleEmailSignUp);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');

        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });
    });

</script>
</body>
</html>

